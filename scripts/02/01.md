# Day 2: Morning

## Unit Testing

- Testing small bits of code to check it works
- Easier to see what's going on than `dump`ing all over the place
- Automated testing is useful as it saves manual testing
- Laravel makes it really easy


### Running Tests

- In `tests/Unit`
- Already an `ExampleText
- `vendor/bin/phpunit --filter Unit`
- Need to filter to avoid "Feature Tests"
- Delete `ExampleTest`

### Generating Tests

- `artisan make:test ArticleTest --unit`
- Look at `ArticleTest`
- Class should end in `Test`
- Methods should start with `test`
- Need to "assert" something

### Assertions

- Saying "x *should* be the case"
- Lots of different ones, but we'll look at
    - `assertTrue`
    - `assertSame`: same type and value
    - Could use `assertTrue` for all, but other methods provide better feedback
- Create an `Article`
    - New method `assertFillable`
    - Create an `Article`
    - Use `assertTrue` to check `title` matches
    - Change to `assertSame`: `expected` then `actual`
    - Add `"danger" => "Aaaaargh!"` property
    - Use `assertSame(null, $article->danger)` to check it's not been added
    - Rerun test: make it fail too
- Last test was a bit pointless, not checking our code
- Add a `truncate` method to `Article`
    - `use Illuminate\Support\Str`
    - `return Str::limit($this->content, 20);`
    - Test once with short content
    - Test with long content
- Setup reused article in `__construct`
    - Make sure to run `parent::__construct()` first
    - Store as property
    - Update tests

### Testing Database

- Use an in-memory SQLite DB
- In `config/database.php`:

    ```php
    'testing' => [
        'driver'   => 'sqlite',
        'database' => ':memory:',
        'prefix'   => '',
    ],
    ```
- Update `phpunit.xml`

    ```xml
    <php>
        // ... other <server /> tags
        <server name="DB_CONNECTION" value="testing"/>
    </php>
    ```

- Update test to use `Tests\TestCase`
- `use Illuminate\Foundation\Testing\DatabaseMigrations;` trait
- Automatically resets database for **each test**
- Use `Article::create()`
    - Get out of DB and use `assertSame`
    - Database wiped for each test, so guaranteed to be first item


### Testing Controllers

- `artisan make:test Http\\Controllers\\API\\ArticlesTest --unit`
    - Update with DB stuff (`use Tests\TestCase` and `DatabaseMigrations`)
    - Add `use` for model
    - Use `$response = $this->call('POST', '/api/articles', [/* data */])->getOriginalContent()`
    - Need `getOriginalContent` so we don't get JSON back
    - Test `$respones->content``
    - Get from DB and check `->content`
    - run tests `vendor/bin/phpunit --filter Unit`
